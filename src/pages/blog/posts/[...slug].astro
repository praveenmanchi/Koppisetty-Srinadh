---
import { getCollection } from "astro:content";
import BlogLayout from "@/layouts/BlogLayout.astro";

export async function getStaticPaths() {
  const blog = await getCollection("posts");
  return blog.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;

// Re-fetch and sort all posts
const allPosts = await getCollection("posts");

const validPosts = allPosts.filter(
  (item) => item.data?.pubDate && item.data?.title
);

const sorted = validPosts.sort(
  (a, b) =>
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

// Get previous and next based on entry.slug
const index = sorted.findIndex((item) => item.slug === entry.slug);
const previous = sorted[index - 1] || null;
const next = sorted[index + 1] || null;

const { Content } = await entry.render();
---

<BlogLayout frontmatter={entry.data} previous={previous} next={next}>
  <Content />
</BlogLayout>
